name: NodeJS Build + Puppeteer Orchestrator + Artifacts

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-and-run:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout code
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Node.js
      - name: ğŸ§± Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3ï¸âƒ£ Install dependencies
      - name: ğŸ“¦ Install npm dependencies
        run: |
          npm ci || npm install
          npm install -D webpack webpack-cli babel-loader @babel/core @babel/preset-env puppeteer-core copy-webpack-plugin

      # 4ï¸âƒ£ Install Google Chrome
      - name: ğŸ“Œ Install Google Chrome
        run: |
          wget -q -O google-chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt install -y ./google-chrome.deb

      # 5ï¸âƒ£ Install Xvfb
      - name: ğŸ“Œ Install Xvfb
        run: sudo apt-get update && sudo apt-get install -y xvfb

      # 6ï¸âƒ£ Build JS with Webpack
      - name: ğŸ—ï¸ Build extension
        run: npx webpack --config webpack.config.js --mode production --stats-error-details

      # 7ï¸âƒ£ Prepare artifacts folders
      - name: ğŸ“ Prepare artifacts folders
        run: mkdir -p artifacts/screenshots artifacts/diagnostics

      # 8ï¸âƒ£ Run Puppeteer orchestrator in headful mode using Xvfb
      - name: ğŸ¤– Run Puppeteer orchestrator (headful with Xvfb)
        run: xvfb-run -a node puppeteer-orchestrator.js
        env:
          EXTENSION_PATH: ${{ github.workspace }}/dist
          CONFIG_PATH: ${{ github.workspace }}/config.json
          CHROME_PATH: /usr/bin/google-chrome
          MAX_RUNTIME_MS: 180000
          SCREENSHOT_INTERVAL_MS: 3000

      # 9ï¸âƒ£ Verify screenshots folder exists
      - name: ğŸ” Verify screenshot directory
        run: |
          echo "Checking screenshot output..."
          if [ -d "artifacts/screenshots" ] && [ "$(ls -A artifacts/screenshots)" ]; then
            echo "âœ… Screenshots exist."
          else
            echo "âš ï¸ No screenshots found!"
          fi

      # ğŸ”Ÿ Package built extension + artifacts
      - name: ğŸ“¦ Package extension and artifacts
        run: |
          mkdir -p release
          zip -r release/OTMenT_build_${{ github.run_number }}.zip \
            dist \
            manifest.json \
            navigator.js \
            content.js \
            options.html \
            jquery-3.7.1.min.js \
            config.json \
            config-schema.json \
            service-account.json \
            artifacts/screenshots \
            artifacts/diagnostics
        working-directory: ${{ github.workspace }}

      # 1ï¸âƒ£1ï¸âƒ£ Upload ZIP artifact (build + screenshots)
      - name: ğŸ“¤ Upload full ZIP package
        uses: actions/upload-artifact@v4
        with:
          name: OTMenT_build_${{ github.run_number }}
          path: release/OTMenT_build_${{ github.run_number }}.zip

      # 1ï¸âƒ£2ï¸âƒ£ Upload screenshots as separate artifact for easy access
      - name: ğŸ–¼ï¸ Upload screenshots folder
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots_${{ github.run_number }}
          path: artifacts/screenshots