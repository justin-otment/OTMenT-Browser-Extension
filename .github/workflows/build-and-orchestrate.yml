name: NodeJS Build + Puppeteer Orchestrator + Artifacts

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-and-run:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout repository
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Node.js
      - name: ğŸ§± Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3ï¸âƒ£ Install dependencies
      - name: ğŸ“¦ Install npm dependencies
        run: |
          npm ci || npm install
          npm install -D webpack webpack-cli babel-loader @babel/core @babel/preset-env copy-webpack-plugin puppeteer-core

      # 4ï¸âƒ£ Install Google Chrome
      - name: ğŸ“Œ Install Google Chrome
        run: |
          wget -q -O google-chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt install -y ./google-chrome.deb

      # 5ï¸âƒ£ Install Xvfb
      - name: ğŸ“Œ Install Xvfb
        run: sudo apt-get update && sudo apt-get install -y xvfb

      # 6ï¸âƒ£ Build JS with Webpack and copy static files
      - name: ğŸ—ï¸ Build extension
        run: npx webpack --config webpack.config.js --mode production --stats-error-details

      # 7ï¸âƒ£ Create artifacts folders for Puppeteer orchestrator
      - name: ğŸ“ Prepare artifacts folders
        run: mkdir -p artifacts/screenshots artifacts/diagnostics

      # 8ï¸âƒ£ Run Puppeteer orchestrator in headful mode using Xvfb
      - name: ğŸ¤– Run Puppeteer orchestrator (headful with Xvfb)
        run: xvfb-run -a node puppeteer-orchestrator.js
        env:
          EXTENSION_PATH: ${{ github.workspace }}/dist
          CONFIG_PATH: ${{ github.workspace }}/config.json
          CHROME_PATH: /usr/bin/google-chrome

      # 9ï¸âƒ£ Package built extension + orchestrator artifacts
      - name: ğŸ“¦ Package extension and artifacts
        run: |
          mkdir -p release
          zip -r release/OTMenT_build_${{ github.run_number }}.zip \
            dist \
            artifacts/screenshots \
            artifacts/diagnostics

      # ğŸ”Ÿ Upload ZIP artifact
      - name: ğŸ“¤ Upload build + orchestrator artifact
        uses: actions/upload-artifact@v4
        with:
          name: OTMenT_build_${{ github.run_number }}
          path: release/OTMenT_build_${{ github.run_number }}.zip