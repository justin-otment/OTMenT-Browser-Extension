name: Extract, Build & Sign Firefox Addon

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      # ---------------------------
      # 1. EXTRACT THE XPI
      # ---------------------------
      - name: Extract XPI to source/
        run: |
          rm -rf source
          mkdir source
          
          # Find the XPI file dynamically
          XPI_FILE=$(ls *.xpi | head -n 1)
          
          if [ -z "$XPI_FILE" ]; then
            echo "‚ùå No XPI file found in repo root!"
            exit 1
          fi
          
          echo "Found XPI: $XPI_FILE"
          unzip "$XPI_FILE" -d source
          ls -R source

      # ---------------------------
      # 2. INSTALL WEB-EXT
      # ---------------------------
      - name: Install web-ext
        run: |
          npm install --global web-ext

      # ---------------------------
      # 3. SIGN THE EXTRACTED SOURCE
      # ---------------------------
      - name: Sign Firefox Extension
        run: |
          web-ext sign \
            --source-dir ./source \
            --api-key ${{ secrets.AMO_JWT_ISSUER }} \
            --api-secret ${{ secrets.AMO_JWT_SECRET }} \
            --channel listed \
            --artifacts-dir ./web-ext-artifacts

      # ---------------------------
      # 4. UPLOAD SIGNED XPI
      # ---------------------------
      - name: Upload signed extension
        uses: actions/upload-artifact@v4
        with:
          name: Signed-Firefox-Addon
          path: web-ext-artifacts/*.xpi