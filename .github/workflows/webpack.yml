name: NodeJS with Webpack + Artifacts

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout code
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Node.js
      - name: ğŸ§± Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3ï¸âƒ£ Install dependencies
      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci || npm install
          npm install -D webpack webpack-cli babel-loader @babel/core @babel/preset-env

      # 4ï¸âƒ£ Build JS with Webpack (ES module config)
      - name: ğŸ—ï¸ Build extension
        run: node --experimental-specifier-resolution=node --loader ts-node/esm node_modules/.bin/webpack --mode production --stats-error-details

      # 5ï¸âƒ£ Package extension safely (exclude service-account.json)
      - name: ğŸ“¦ Package built extension
        run: |
          mkdir -p release
          zip -r release/OTMenT_build_${{ github.run_number }}.zip \
            dist \
            manifest.json \
            options.html \
            jquery-3.7.1.min.js \
            config.json \
            config-schema.json

      # 6ï¸âƒ£ Upload ZIP artifact
      - name: ğŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: OTMenT_build_${{ github.run_number }}
          path: release/OTMenT_build_${{ github.run_number }}.zip