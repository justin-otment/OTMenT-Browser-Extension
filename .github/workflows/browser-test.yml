name: Browser tests (non-headless)

on: [push, pull_request]

permissions:
  contents: read
  actions: write

jobs:
  browser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install APT deps and enable universe
        run: |
          sudo apt-get update -y
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository -y universe
          sudo apt-get update -y
          apt-cache policy libasound2 libasound2t64 liboss4-salsa-asound2 || true
          sudo apt-get install -y --no-install-recommends \
            xvfb \
            libgtk-3-0 \
            libxss1 \
            libasound2t64 \
            fonts-liberation \
            libgbm-dev \
            libnss3-dev \
            libu2f-udev \
            xdg-utils

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: latest
          install-dependencies: true

      - name: Install npm packages
        run: npm ci

      - name: Ensure chromedriver is available (npm)
        run: |
          # chromedriver is installed as an npm dependency and exposes a binary via node_modules/.bin
          ls -la node_modules/.bin || true
          node -e "console.log(require('chromedriver').path || 'chromedriver not found')"

      - name: Create artifact folders
        run: |
          mkdir -p artifacts/screenshots
          mkdir -p artifacts/videos || true

      - name: Show package.json scripts
        run: |
          echo "package.json:"
          cat package.json
          echo "npm run (available scripts):"
          npm run

      - name: Diagnostics - list repo and extension files
        run: |
          echo "Working dir: $(pwd)"
          echo "Manifest exists:"; test -f manifest.json && echo "yes" || echo "no"
          echo "List root files:"; ls -la
          echo "Show manifest (first 200 lines):"; sed -n '1,200p' manifest.json || true
          echo "List extension-related JS files (if present):"; ls -la | grep -E "background.js|manifest.json|options.html|options.js|solver.detector.content.js|crypto-utils.js|crypto-worker.js" || true

      - name: Print raw test page URL (for debugging)
        run: |
          echo "GITHUB_REPOSITORY=${GITHUB_REPOSITORY}"
          REF=${GITHUB_REF_NAME:-$(echo ${GITHUB_REF:-main} | sed -e 's@refs/heads/@@')}
          echo "Using ref: $REF"
          echo "Raw test page URL: https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${REF}/otment-test.html"

      - name: Run headed tests under Xvfb
        env:
          CI: true
          # expose branch/ref name for run-headed-tests.js
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          # Start X virtual framebuffer and run the test script that launches Chrome in headed mode
          # timeout ensures xvfb-run doesn't hang forever
          xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" npm run test:headed
        timeout-minutes: 20
        continue-on-error: false

      - name: Collect browser logs and diagnostics
        if: always()
        run: |
          echo "Chrome version:"
          google-chrome --version || chromium --version || true
          echo "List artifacts directory:"
          ls -la artifacts || true
          echo "Preview browser logs (first 200 lines):"
          sed -n '1,200p' artifacts/extension-browser-logs.json || true
          echo "List screenshots (if any):"; ls -la artifacts/screenshots || true

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: browser-artifacts
          path: artifacts
