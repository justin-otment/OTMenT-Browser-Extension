name: Browser tests (non-headless)

on: [push, pull_request]

permissions:
  contents: read
  actions: write

jobs:
  browser:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install APT deps and enable universe
        run: |
          sudo apt-get update -y
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository -y universe
          sudo apt-get update -y
          apt-cache policy libasound2 libasound2t64 liboss4-salsa-asound2 || true
          sudo apt-get install -y --no-install-recommends \
            xvfb \
            libgtk-3-0 \
            libxss1 \
            libasound2t64 \
            fonts-liberation \
            libgbm-dev \
            libnss3-dev \
            libu2f-udev \
            xdg-utils \
            openvpn \
            iproute2 \
            iputils-ping \
            curl

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: latest
          install-dependencies: true

      - name: Install npm packages
        run: npm ci

      - name: Ensure chromedriver is available (npm)
        run: |
          ls -la node_modules/.bin || true
          node -e "console.log(require('chromedriver').path || 'chromedriver not found')"

      - name: Create artifact folders
        run: |
          mkdir -p artifacts/screenshots
          mkdir -p artifacts/diagnostics
          mkdir -p artifacts/videos || true

      - name: Show package.json scripts
        run: |
          echo "package.json:"
          cat package.json
          echo "npm run (available scripts):"
          npm run

      - name: Diagnostics - list repo and extension files
        run: |
          echo "Working dir: $(pwd)"
          echo "Manifest exists:"; test -f manifest.json && echo "yes" || echo "no"
          echo "List root files:"; ls -la
          echo "Show manifest (first 200 lines):"; sed -n '1,200p' manifest.json || true
          echo "List extension-related JS files:"; ls -la | grep -E "background.js|manifest.json|options.html|options.js|solver.detector.content.js|crypto-utils.js|crypto-worker.js" || true

      - name: Ensure test page exists
        run: |
          if [ ! -f "otment-test.html" ]; then
            echo "⚠️  otment-test.html missing — creating minimal fallback page..."
            cat <<'EOF' > otment-test.html
          <!DOCTYPE html>
          <html lang="en">
          <head><meta charset="UTF-8"><title>OTMenT Test Page</title></head>
          <body>
            <div id="otment-status">Initializing...</div>
            <script>
              setTimeout(()=>{document.getElementById('otment-status').classList.add('active');},1500);
            </script>
          </body>
          </html>
          EOF
                    fi
                    echo "✅ Verified otment-test.html present."


      - name: Start OpenVPN using repo VPN config (non-fatal)
        continue-on-error: true
        env:
          CI: true
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE"

          OVPN="VPN/client.ovpn"
          AUTH="VPN/auth.txt"
          PIDFILE="/tmp/openvpn.pid"
          LOGFILE="/tmp/openvpn.log"

          if [ ! -f "$OVPN" ]; then
            echo "⚠️  OpenVPN config not found at $OVPN — skipping VPN start (non-fatal)."
            ls -la VPN || true
          else
            echo "Starting OpenVPN service..."
            if grep -q "auth-user-pass" "$OVPN"; then
              sudo nohup openvpn --config "$OVPN" --auth-user-pass "$AUTH" --daemon --writepid "$PIDFILE" --log "$LOGFILE" || true
            else
              sudo nohup openvpn --config "$OVPN" --daemon --writepid "$PIDFILE" --log "$LOGFILE" || true
            fi

            echo "Waiting up to 30s for tun0..."
            for i in $(seq 1 30); do
              if /sbin/ip a | grep -q tun0; then
                echo "tun0 present"
                break
              fi
              sleep 1
            done

            if ! /sbin/ip a | grep -q tun0; then
              echo "⚠️  VPN interface tun0 not detected; printing last 100 lines of OpenVPN log:"
              tail -n 100 "$LOGFILE" || true
            fi

            echo "Routing table (partial):"
            /sbin/ip route | sed -n '1,50p' || true
            echo "External IP (via curl):"
            curl -sS https://ifconfig.co || true
          fi

      - name: Start local static server for test page
        run: |
          npm install -g http-server@14 || true
          nohup npx http-server -p 8080 -c-1 . > /tmp/http-server.log 2>&1 &
          echo "Started http-server; waiting..."
          for i in $(seq 1 10); do
            if curl -sSf http://127.0.0.1:8080/otment-test.html >/dev/null 2>&1; then
              echo "✅ Test page reachable."
              break
            fi
            sleep 1
          done
          if ! curl -sSf http://127.0.0.1:8080/otment-test.html >/dev/null 2>&1; then
            echo "❌ Local test page not reachable."
            cat /tmp/http-server.log || true
            exit 1
          fi

      - name: Export TEST_PAGE_URL and CHROME_ARGS
        run: |
          echo "TEST_PAGE_URL=http://127.0.0.1:8080/otment-test.html" >> $GITHUB_ENV
          CHROME_ARGS="--disable-extensions-except=${PWD} --load-extension=${PWD} --enable-unsafe-swiftshader --no-sandbox --disable-dev-shm-usage --window-size=1920,1080"
          echo "CHROME_ARGS=$CHROME_ARGS" >> $GITHUB_ENV

      - name: Print raw test page URL (for debugging)
        run: |
          echo "Repo: ${GITHUB_REPOSITORY}"
          REF=${GITHUB_REF_NAME:-$(echo ${GITHUB_REF:-main} | sed -e 's@refs/heads/@@')}
          echo "Using ref: $REF"
          echo "TEST_PAGE_URL=${TEST_PAGE_URL}"
          echo "CHROME_ARGS=${CHROME_ARGS}"

      - name: Capture pre-run chrome://extensions/ (placeholder)
        run: |
          node -e "console.log('skip: capture occurs inside run-headed-tests.js')"

      - name: Run headed tests under Xvfb
        env:
          CI: true
          GITHUB_REF_NAME: ${{ github.ref_name }}
          TEST_PAGE_URL: ${{ env.TEST_PAGE_URL }}
          CHROME_ARGS: ${{ env.CHROME_ARGS }}
        run: |
          xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" npm run test:headed
        timeout-minutes: 30
        continue-on-error: false

      - name: Verify artifacts produced (fail if missing)
        if: always()
        run: |
          echo "Listing artifacts:"
          ls -la artifacts || true
          echo "Checking extension-browser-logs.json..."
          if [ ! -s artifacts/extension-browser-logs.json ]; then
            echo "ERROR: artifacts/extension-browser-logs.json missing or empty" >&2
            mkdir -p artifacts/diagnostics
            [ -f /tmp/openvpn.log ] && cp /tmp/openvpn.log artifacts/diagnostics/openvpn.log || true
            exit 1
          fi

      - name: Collect browser logs and diagnostics
        if: always()
        run: |
          google-chrome --version || chromium --version || true
          echo "Artifacts dir:"
          ls -la artifacts || true
          echo "Preview logs:"
          sed -n '1,200p' artifacts/extension-browser-logs.json || true
          echo "Diagnostics files:"
          ls -la artifacts/diagnostics || true
          echo "Screenshots:"
          ls -la artifacts/screenshots || true
          if [ -f /tmp/openvpn.log ]; then
            tail -n 200 /tmp/openvpn.log || true
            cp /tmp/openvpn.log artifacts/diagnostics/openvpn.log || true
          fi

      - name: Disconnect OpenVPN (cleanup)
        if: always()
        run: |
          PIDFILE="/tmp/openvpn.pid"
          if [ -f "$PIDFILE" ]; then
            pid=$(cat "$PIDFILE") || true
            [ -n "$pid" ] && sudo kill "$pid" || true
            rm -f "$PIDFILE" || true
          fi
          pkill -f openvpn || true

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: browser-artifacts
          path: |
            artifacts/extension-browser-logs.json
            artifacts/extension-browser-logs-summary.json
            artifacts/diagnostics/**
            artifacts/screenshots/**
            artifacts/videos/**
