name: üß© OTMenT Extension Runner (via Puppeteer + VPN)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: read

jobs:
  browser:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      # =========================================
      # 1. üß© Setup Environment
      # =========================================
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Linux dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            xvfb libgtk-3-0 libxss1 libasound2t64 \
            libgbm-dev libnss3-dev libu2f-udev xdg-utils \
            openvpn curl jq iproute2

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: latest
          install-dependencies: true

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}

      - name: Install Node dependencies
        env:
          CI: true
        run: |
          echo "üì¶ Installing Node dependencies..."
          npm ci --ignore-scripts || npm install --legacy-peer-deps
          echo "üì¶ Installing Puppeteer (required in CI)..."
          npm install puppeteer

      - name: üîê Decode service account key
        run: |
          echo "${{ secrets.GSHEETS_SERVICE_KEY_B64 }}" | base64 --decode > service-account.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=$PWD/service-account.json" >> $GITHUB_ENV

      - name: Detect Chrome binary
        id: chrome
        run: |
          CHROME_BIN=$(which google-chrome || which chromium || true)
          if [ -z "$CHROME_BIN" ]; then
            echo "‚ùå Chrome binary not found"; exit 1;
          fi
          echo "CHROME_BIN=$CHROME_BIN" >> $GITHUB_ENV
          "$CHROME_BIN" --version

      # =========================================
      # 2. üåê Setup VPN Connection
      # =========================================
      - name: Connect OpenVPN
        run: |
          VPN_DIR="VPN"
          AUTH_FILE="$VPN_DIR/auth.txt"
          OVPN=$(find "$VPN_DIR" -name "*.ovpn" | head -n1)
          if [ -z "$OVPN" ]; then
            echo "‚ùå No .ovpn config found."; exit 1;
          fi
          echo "üåç Using VPN config: $OVPN"
          sudo nohup openvpn --config "$OVPN" \
            --auth-user-pass "$AUTH_FILE" \
            --daemon --writepid /tmp/openvpn.pid \
            --log /tmp/openvpn.log
          echo "üïê Waiting for VPN to establish..."
          sleep 10
          echo "üåé External IP (via VPN):"
          curl -s https://ifconfig.me || true

      # =========================================
      # 3. üß± Prepare Extension
      # =========================================
      - name: Package Chrome Extension
        run: |
          EXT_SRC=$(find . -maxdepth 3 -name "manifest.json" -printf '%h\n' | head -n1)
          if [ -z "$EXT_SRC" ]; then
            echo "‚ùå Could not find manifest.json"; exit 1;
          fi
          EXT_PATH="/tmp/otment-extension"
          mkdir -p "$EXT_PATH"
          cp -r "$EXT_SRC/." "$EXT_PATH/"
          echo "EXTENSION_PATH=$EXT_PATH" >> $GITHUB_ENV
          echo "‚úÖ Extension prepared at: $EXT_PATH"

      # =========================================
      # 4. üöÄ Puppeteer + OTMenT Orchestrator
      # =========================================
      - name: Run Puppeteer Orchestrator
        env:
          CHROME_PATH: ${{ env.CHROME_BIN }}
          EXTENSION_PATH: ${{ env.EXTENSION_PATH }}
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: "1"
          TEST_PAGE_URL: "https://www.peoplesearchnow.com/address/195-new-lots-avenue_brooklyn-ny"
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/service-account.json
        run: |
          echo "üöÄ Starting Puppeteer with OTMenT extension..."
          mkdir -p artifacts/diagnostics
          xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" \
            node scripts/orchestrator.js || echo "‚ö†Ô∏è Puppeteer run exited with code $?"

      # =========================================
      # 5. üì¶ Post-run and Cleanup
      # =========================================
      - name: Collect Logs
        if: always()
        run: |
          mkdir -p artifacts/diagnostics
          cp /tmp/openvpn.log artifacts/diagnostics/openvpn.log || true
          echo "‚úÖ Logs collected."

      - name: Disconnect VPN
        if: always()
        run: |
          sudo pkill -f openvpn || true
          echo "‚úÖ VPN disconnected."

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: otment-artifacts
          path: artifacts/**
