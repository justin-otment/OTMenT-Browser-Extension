name: Browser tests (non-headless)

on: [push, pull_request]

permissions:
  contents: read
  actions: write

jobs:
  browser:
    runs-on: ubuntu-latest

    steps:
      # ===========================
      # 1. Setup and Preparation
      # ===========================
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      - name: üß± Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üß∞ Install system dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository -y universe
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            xvfb libgtk-3-0 libxss1 libasound2t64 fonts-liberation \
            libgbm-dev libnss3-dev libu2f-udev xdg-utils openvpn \
            iproute2 iputils-ping curl python3 python3-pip jq

      - name: üåê Setup Chrome (Chromium)
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: latest
          install-dependencies: true
          install-chromedriver: false

      - name: üíæ Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-cache-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            npm-cache-${{ runner.os }}-

      - name: üíæ Cache Puppeteer Chromium
        uses: actions/cache@v4
        with:
          path: ~/.cache/puppeteer
          key: puppeteer-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: puppeteer-${{ runner.os }}-

      - name: üì¶ Install npm packages (robust)
        env:
          CI: true
        run: |
          set -euo pipefail
          echo "Attempting npm ci (deterministic)..."
          if npm ci --ignore-scripts --no-audit --no-fund; then
            echo "‚úÖ npm ci succeeded"
          else
            echo "‚ö† npm ci failed ‚Äî falling back to npm install --legacy-peer-deps"
            npm install --legacy-peer-deps --no-audit --no-fund
          fi

      - name: üß© Export Chrome binary for Puppeteer
        run: |
          CHROME_BIN=$(which google-chrome || which chromium || true)
          echo "‚úÖ Found Chrome binary: $CHROME_BIN"
          echo "PUPPETEER_EXECUTABLE_PATH=$CHROME_BIN" >> $GITHUB_ENV
          echo "CHROME_PATH=$CHROME_BIN" >> $GITHUB_ENV

      - name: üß† Verify Puppeteer Chromium setup
        run: |
          set -e
          echo "üîç Checking Puppeteer setup..."
          node - <<'EOF'
          import puppeteer from 'puppeteer-core';
          const browserPath = process.env.PUPPETEER_EXECUTABLE_PATH;
          (async () => {
            try {
              const browser = await puppeteer.launch({
                headless: true,
                executablePath: browserPath,
                args: ['--no-sandbox', '--disable-setuid-sandbox']
              });
              const version = await browser.version();
              console.log("‚úÖ Puppeteer successfully launched:", version);
              await browser.close();
            } catch (err) {
              console.error("‚ùå Puppeteer sanity check failed:");
              console.error(err);
              process.exit(1);
            }
          })();
          EOF

      - name: üïµÔ∏è Locate Chrome binary
        id: chrome-bin
        run: |
          CHROME_BIN=$(which google-chrome || which chromium || true)
          if [ -z "$CHROME_BIN" ]; then
            CHROME_BIN=$(find /opt/hostedtoolcache/setup-chrome -type f -name chrome | head -n1)
          fi
          if [ -z "$CHROME_BIN" ]; then
            echo "‚ùå Chrome binary not found."; exit 1
          fi
          echo "‚úÖ Using Chrome binary: $CHROME_BIN"
          echo "CHROME_BIN=$CHROME_BIN" >> $GITHUB_ENV
          "$CHROME_BIN" --version

      - name: üóÇÔ∏è Prepare artifact directories
        run: mkdir -p artifacts/{screenshots,diagnostics,videos}

      # ===========================
      # 2. VPN Rotation (Mock-Safe)
      # ===========================
      - name: üîÅ Rotate and connect OpenVPN
        run: |
          set -euo pipefail
          VPN_DIR="VPN"
          AUTH_FILE="$VPN_DIR/auth.txt"
          STATE_FILE="$VPN_DIR/rotation_state.txt"
          PIDFILE="/tmp/openvpn.pid"
          LOGFILE="/tmp/openvpn.log"

          # --- Ensure log file is writable ---
          sudo rm -f "$LOGFILE" 2>/dev/null || true
          sudo touch "$LOGFILE"
          sudo chmod 666 "$LOGFILE"

          # --- Helper: Safe IP fetch ---
          get_ip() {
            local ip
            ip=$(curl -sS https://api.ipify.org || curl -sS https://ifconfig.me || curl -sS https://ifconfig.co/ip || echo "unknown")
            [[ "$ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]] && echo "$ip" || echo "unknown"
          }

          # --- Collect .ovpn files ---
          mapfile -t OVPN_LIST < <(find "$VPN_DIR" -maxdepth 1 -type f -name "*.ovpn" | sort)
          if [ ${#OVPN_LIST[@]} -eq 0 ]; then
            echo "‚ùå No .ovpn found in $VPN_DIR"; exit 1
          fi
          [ -f "$AUTH_FILE" ] || { echo "‚ùå Missing $AUTH_FILE"; exit 1; }

          # --- Rotation logic ---
          if [ -f "$STATE_FILE" ]; then
            LAST=$(cat "$STATE_FILE" || true)
            IDX=$(printf '%s\n' "${OVPN_LIST[@]}" | grep -nFx "$LAST" | cut -d: -f1 || echo 0)
            [ -z "$IDX" ] || [ "$IDX" -eq 0 ] && NEXT_INDEX=0 || NEXT_INDEX=$(( IDX % ${#OVPN_LIST[@]} ))
            NEXT="${OVPN_LIST[$NEXT_INDEX]}"
          else
            NEXT="${OVPN_LIST[0]}"
          fi
          echo "$NEXT" > "$STATE_FILE"
          echo "üß≠ Using VPN config: $NEXT"

          BASE_IP=$(get_ip)
          echo "üåê Base IP: $BASE_IP"

          # --- Mock mode check ---
          if [ ! -e /dev/net/tun ] || ! sudo modprobe tun 2>/dev/null; then
            echo "‚ö†Ô∏è  TUN not available ‚Äî entering mock VPN mode."
            echo "[mock vpn] $(date)" > "$LOGFILE"
            echo "üåê (mock) VPN simulated successfully."
            exit 0
          fi

          # --- Attempt OpenVPN ---
          echo "üöÄ Starting OpenVPN..."
          sudo pkill -f openvpn || true
          VPN_FAIL=0
          if grep -q "auth-user-pass" "$NEXT"; then
            sudo nohup openvpn --config "$NEXT" \
              --auth-user-pass "$AUTH_FILE" \
              --daemon --writepid "$PIDFILE" --log "$LOGFILE" || VPN_FAIL=1
          else
            sudo nohup openvpn --config "$NEXT" \
              --daemon --writepid "$PIDFILE" --log "$LOGFILE" || VPN_FAIL=1
          fi

          sleep 5
          if [ ! -f "$PIDFILE" ] || [ "$VPN_FAIL" -eq 1 ]; then
            echo "‚ö†Ô∏è  OpenVPN failed ‚Äî switching to mock VPN mode."
            echo "[mock vpn fallback] $(date)" > "$LOGFILE"
            echo "üåê (mock) VPN simulated successfully."
            exit 0
          fi

          echo "‚è≥ Waiting for tun0 interface..."
          for i in $(seq 1 60); do
            ip a show tun0 &>/dev/null && break
            sleep 1
          done
          if ! ip a show tun0 &>/dev/null; then
            echo "‚ùå VPN interface not found"
            tail -n 100 "$LOGFILE" || true
            exit 1
          fi

          VPN_IP=$(get_ip)
          echo "üåê VPN IP: $VPN_IP"

          if [ "$VPN_IP" == "$BASE_IP" ] || [ "$VPN_IP" == "unknown" ]; then
            echo "‚ùå VPN connection failed to change IP"
            tail -n 100 "$LOGFILE" || true
            exit 1
          else
            echo "‚úÖ VPN connection established successfully!"
          fi

      # ===========================
      # 3. Chrome + Extension Setup
      # ===========================
      - name: ‚öôÔ∏è Detect and inject unpacked Chrome extension
        run: |
          set -euo pipefail
          TMP_EXT="/tmp/otment-extension"
          rm -rf "$TMP_EXT"
          mkdir -p "$TMP_EXT"

          EXT_SRC=$(find "${GITHUB_WORKSPACE}" -maxdepth 3 -name "manifest.json" -printf '%h\n' | head -n1)
          if [ -z "$EXT_SRC" ]; then
            echo "‚ùå manifest.json not found ‚Äî cannot load extension"
            exit 1
          fi

          echo "üì¶ Copying Chrome extension from: $EXT_SRC"
          cp -r "$EXT_SRC/." "$TMP_EXT/"
          sudo chmod -R 755 "$TMP_EXT" || true

          echo "EXTENSION_PATH=$TMP_EXT" >> $GITHUB_ENV
          echo "CHROME_ARGS=--no-sandbox --disable-dev-shm-usage --disable-gpu --window-size=1920,1080 --disable-extensions-except=$TMP_EXT --load-extension=$TMP_EXT" >> $GITHUB_ENV
          echo "‚úÖ Extension ready at: $TMP_EXT"

      # ===========================
      # 4. Orchestrator Runner
      # ===========================
      - name: üöÄ Run OTMenT CI Orchestrator
        run: node scripts/orchestrator.js

      # ===========================
      # 5. Post-Run Cleanup
      # ===========================
      - name: üßæ Collect diagnostics and screenshots
        if: always()
        run: |
          ls -la artifacts/screenshots || true
          [ -f /tmp/openvpn.log ] && cp /tmp/openvpn.log artifacts/diagnostics/openvpn.log || true

      - name: üîå Disconnect VPN
        if: always()
        run: |
          sudo pkill -f openvpn || true
          echo "‚úÖ VPN disconnected."

      - name: üì§ Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: browser-artifacts
          path: |
            artifacts/diagnostics/**
            artifacts/screenshots/**
            artifacts/videos/**
